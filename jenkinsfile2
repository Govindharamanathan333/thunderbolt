pipeline {
    agent any

    environment {
        GIT_USERNAME = 'Govindharamanathan333' // Replace with the GitHub username
        REPO_DIR = 'thunderbolt' // Name of the directory where the repo will be cloned
    }

    stages {
        stage('Check & Clean Existing Repository') {
            steps {
                script {
                    // Check if the repository directory exists
                    if (fileExists(REPO_DIR)) {
                        echo "Repository directory ${REPO_DIR} already exists. Deleting..."
                        sh "rm -rf ${REPO_DIR}" // Remove the existing directory
                    } else {
                        echo "No existing repository found. Proceeding to clone."
                    }
                }
            }
        }

        stage('Clone Repository') {
            steps {
                script {
                    // Clone the repository using the GitHub username
                    echo "Cloning repository for user: ${GIT_USERNAME}"
                    sh "git clone https://github.com/${GIT_USERNAME}/thunderbolt.git"
                }
            }
        }

        stage('Get Latest Commit Info') {
            steps {
                script {
                    // Get the latest commit message from the cloned repository
                    def latestCommitMessage = sh(
                        script: "cd ${REPO_DIR} && git log -1 --pretty=%B", 
                        returnStdout: true
                    ).trim()
                    echo "Latest commit message: ${latestCommitMessage}"

                    // Get the latest commit author
                    def latestCommitAuthor = sh(
                        script: "cd ${REPO_DIR} && git log -1 --pretty=%an", 
                        returnStdout: true
                    ).trim()
                    echo "Latest commit author: ${latestCommitAuthor}"
                }
            }
        }

        stage('Send Notification') {
            steps {
                script {
                    // Get Jenkins build details
                    def buildUser = env.BUILD_USER_ID ?: 'unknown' // Get the user who triggered the build
                    def buildNumber = env.BUILD_NUMBER // Jenkins build number
                    def jobName = env.JOB_NAME // Jenkins job name
                    def buildUrl = env.BUILD_URL // Jenkins build URL

                    // Send a custom notification to Rocket.Chat
                    rocketSend(
                        message: """
                        *Build Notification:*
                        - *Job Name*: ${jobName}
                        - *Build Number*: ${buildNumber}
                        - *Triggered By*: ${buildUser}
                        - *Repository*: https://github.com/${GIT_USERNAME}/thunderbolt
                        - *Latest Commit Author*: ${latestCommitAuthor}
                        - *Latest Commit Message*: ${latestCommitMessage}
                        - *Build URL*: ${buildUrl}
                        """
                    )
                }
            }
        }
    }

    post {
        success {
            echo 'Pipeline completed successfully.'
        }
        failure {
            echo 'Pipeline failed.'
        }
    }
}
